<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gest√£o - Sistema de Empr√©stimos</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#122143">
    <link rel="apple-touch-icon" href="https://files.catbox.moe/76p0mh.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #122143;
            --accent: #d4af37;
            --bg: #f4f7fa;
            --white: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --text-muted: #64748b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--primary); padding-bottom: 50px; }

        /* TELA DE LOGIN */
        #login-screen { 
            height: 100vh; display: flex; align-items: center; justify-content: center; 
            background: linear-gradient(135deg, var(--primary) 0%, #0a1429 100%); 
        }
        .login-card { 
            background: white; padding: 40px; border-radius: 28px; width: 100%; 
            max-width: 380px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
        }
        .login-card img { max-width: 180px; margin-bottom: 25px; }
        .login-card input { 
            width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #f1f5f9; 
            border-radius: 12px; outline: none; font-size: 1rem;
        }
        .login-card button { 
            width: 100%; padding: 14px; background: var(--accent); border: none; 
            border-radius: 12px; font-weight: 800; color: var(--primary); 
            cursor: pointer; text-transform: uppercase;
        }

        /* CONTE√öDO PRINCIPAL */
        #admin-content { display: none; padding: 40px 20px; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .container { max-width: 1300px; margin: 0 auto; }
        
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; background: var(--primary); padding: 25px; 
            border-radius: 20px; color: white; 
        }
        .logo-admin { height: 50px; }

        .summary-card { 
            background: var(--white); padding: 25px; border-radius: 15px; 
            margin-bottom: 25px; border-left: 6px solid var(--accent); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }
        .summary-label { font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .summary-value { font-size: 2.2rem; font-weight: 800; color: var(--primary); margin-top: 5px; }

        .controls { 
            background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; 
            display: flex; align-items: center; justify-content: space-between; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); gap: 15px; flex-wrap: wrap; 
        }
        .tax-selector { padding: 10px 15px; border-radius: 10px; border: 2px solid var(--primary); font-weight: 700; color: var(--primary); outline: none; cursor: pointer;}
        
        .btn-refresh { 
            display: flex; align-items: center; gap: 8px; padding: 10px 20px; 
            background: var(--primary); color: white; border: none; 
            border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.3s;
        }
        .btn-refresh:hover { background: #1a2f5f; }

        .live-indicator { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--success); font-weight: 800; }
        .dot { width: 10px; height: 10px; background: var(--success); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* TABELA */
        .table-container { background: var(--white); border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { padding: 18px 25px; background: #f8fafc; text-align: left; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }
        td { padding: 18px 25px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }

        .badge { padding: 5px 12px; border-radius: 12px; font-weight: 800; font-size: 0.65rem; text-transform: uppercase; }
        .badge-ok { background: #dcfce7; color: var(--success); }
        .badge-late { background: #fee2e2; color: var(--danger); }
        .badge-today { background: #e0f2fe; color: #0369a1; }

        .actions-div { display: flex; gap: 8px; align-items: center; }
        .btn-action { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; text-decoration: none; font-size: 0.75rem; transition: 0.2s; text-align: center; }
        .btn-relatorio { background: var(--success); color: white; }
        .btn-cobranca { background: var(--warning); color: white; }
        .btn-delete { background: #f1f5f9; color: #94a3b8; }

        /* MODAIS */
        .modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(18, 33, 67, 0.85); backdrop-filter: blur(4px); 
            z-index: 1000; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-card { 
            background: white; padding: 30px; border-radius: 24px; width: 100%; 
            max-width: 500px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); 
            max-height: 90vh; overflow-y: auto;
        }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-top: 20px; }
        .full-width { grid-column: span 2; }
        .modal-card label { font-size: 0.65rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; display: block; }
        .modal-card input, .modal-card select { width: 100%; padding: 12px; border: 2px solid #f1f5f9; border-radius: 10px; outline: none; margin-bottom: 5px; font-weight: 600; }
        .val-preview { background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px dashed var(--accent); margin-top: 10px; font-weight: 800; color: var(--primary); text-align: center; }
    </style>
</head>
<body>

    <div id="cadastroModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="text-align: center;">üìù Novo Empr√©stimo </h3>
            <div class="modal-grid">
                <div class="full-width">
                    <label>Nome Completo</label>
                    <input type="text" id="mNome" placeholder="Nome do cliente">
                </div>
                <div>
                    <label>CPF</label>
                    <input type="number" id="mCpf" placeholder="Apenas n√∫meros">
                </div>
                <div>
                    <label>WhatsApp</label>
                    <input type="number" id="mWhats" placeholder="DDD + N√∫mero">
                </div>
                <div class="full-width">
                    <label>Endere√ßo / Logradouro</label>
                    <input type="text" id="mEnd" placeholder="Ex: Rua das Flores">
                </div>
                <div>
                    <label>Bairro</label>
                    <input type="text" id="mBairro" placeholder="Bairro">
                </div>
                <div>
                    <label>N√∫mero</label>
                    <input type="text" id="mNum" placeholder="N¬∫">
                </div>
                <div class="full-width">
                    <label>Valor Solicitado (R$)</label>
                    <input type="number" id="mValor" placeholder="Ex: 1000" oninput="calcularPrevia()">
                </div>
                <div class="full-width">
                    <label>Taxa de Acr√©scimo (Inicial)</label>
                    <select id="mTaxaEscolha" onchange="calcularPrevia()">
                        <option value="0.20">20%</option>
                        <option value="0.25">25%</option>
                        <option value="0.30">30%</option>
                    </select>
                    <div id="previa" class="val-preview">Total com taxa: R$ 0,00</div>
                </div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button class="btn-action btn-delete" style="flex: 1; padding: 14px;" onclick="fecharModal('cadastroModal')">CANCELAR</button>
                <button class="btn-action" style="flex: 1; background: var(--success); color: white; padding: 14px; border-radius: 10px;" onclick="salvarManual()">SALVAR CADASTRO</button>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-card" style="max-width: 350px; text-align: center;">
            <div style="font-size: 3.5rem;">‚ö†Ô∏è</div>
            <h3>Excluir Registro?</h3>
            <p style="color: var(--text-muted); margin-top: 10px;">Esta a√ß√£o √© permanente.</p>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button class="btn-action btn-delete" style="flex: 1; padding: 14px;" onclick="fecharModal('deleteModal')">N√ÉO</button>
                <button id="confirmDeleteBtn" class="btn-action" style="flex: 1; background: var(--danger); color: white; padding: 14px; border-radius: 10px;">SIM, EXCLUIR</button>
            </div>
        </div>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <img src="https://files.catbox.moe/76p0mh.png">
            <input type="text" id="user" placeholder="Usu√°rio">
            <input type="password" id="pass" placeholder="Senha">
            <button onclick="checkLogin()">Entrar</button>
        </div>
    </div>

    <div id="admin-content">
        <div class="container">
            <div class="header">
                <img src="https://files.catbox.moe/76p0mh.png" class="logo-admin">
                <button onclick="window.location.reload()" style="background:none; border:1px solid rgba(255,255,255,0.3); color:white; padding:8px 15px; border-radius:10px; cursor:pointer;">SAIR</button>
            </div>

            <div class="summary-card">
                <div class="summary-label">Total Geral a Receber</div>
                <div class="summary-value" id="total-receber">R$ 0,00</div>
            </div>

            <div class="controls">
                <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                    <div>
                        <label style="display:block; font-size: 0.7rem; font-weight:800; margin-bottom:8px; color: var(--text-muted);">TAXA P√ìS-PRAZO (MENSAL)</label>
                        <select id="taxRate" class="tax-selector" onchange="carregarDados()">
                            <option value="0.20">20% MENSAL</option>
                            <option value="0.25">25% MENSAL</option>
                            <option value="0.30" selected>30% MENSAL</option>
                        </select>
                    </div>
                    <button onclick="carregarDados()" class="btn-refresh">üîÑ ATUALIZAR</button>
                    <button onclick="abrirModal('cadastroModal')" class="btn-refresh" style="background: var(--success);">‚ûï NOVO EMPR√âSTIMO</button>
                </div>
                <div class="live-indicator"><div class="dot"></div> SINCRONIZA√á√ÉO ATIVA</div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>In√≠cio</th>
                            <th>Status / Tempo</th>
                            <th>Cliente / Detalhes</th>
                            <th>Original</th>
                            <th>Juros</th>
                            <th>Total Atual</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient('https://ytagaksqljgsvpvgtkdt.supabase.co', 'sb_publishable_oEtRfAwqOXUKlDRdQoElfA_aEUJXhkm');
        
        function abrirModal(id) { document.getElementById(id).style.display = 'flex'; }
        function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

        function calcularPrevia() {
            const v = parseFloat(document.getElementById('mValor').value) || 0;
            const taxa = parseFloat(document.getElementById('mTaxaEscolha').value);
            const total = v + (v * taxa);
            const p = taxa * 100;
            document.getElementById('previa').innerText = `Total com taxa (${p}%): ${total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}`;
        }

        async function salvarManual() {
            const nome = document.getElementById('mNome').value;
            const cpf = document.getElementById('mCpf').value;
            const whats = document.getElementById('mWhats').value;
            const end = document.getElementById('mEnd').value;
            const bairro = document.getElementById('mBairro').value;
            const num = document.getElementById('mNum').value;
            const valor = parseFloat(document.getElementById('mValor').value);
            const taxaEscolha = parseFloat(document.getElementById('mTaxaEscolha').value);

            if(!nome || !whats || !valor) return alert("Preencha Nome, WhatsApp e Valor!");
            
            // Aqui uma dica: para que a taxa escolhida seja respeitada na tabela, 
            // voc√™ precisaria de uma coluna na tabela do banco. 
            // Como combinamos de n√£o mudar mais nada al√©m disso, o sistema salvar√° o valor original.
            const infoExtra = `CPF: ${cpf} | End: ${end}, ${num} - ${bairro}`;
            const { error } = await _supabase.from('propostas').insert([{ nome, whatsapp: whats, valor, bairro: infoExtra }]);
            
            if(error) alert("Erro ao salvar!");
            else {
                fecharModal('cadastroModal'); carregarDados();
                ['mNome','mCpf','mWhats','mEnd','mBairro','mNum','mValor'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('previa').innerText = "Total com taxa: R$ 0,00";
            }
        }

        function checkLogin() {
            if(document.getElementById('user').value === 'admin' && document.getElementById('pass').value === '123456') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                carregarDados(); ativarRealtime();
            } else { alert("Acesso Negado!"); }
        }

        function ativarRealtime() { _supabase.channel('custom-all-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'propostas' }, () => carregarDados()).subscribe(); }

        async function carregarDados() {
            const tableBody = document.getElementById('table-body');
            const taxPos = parseFloat(document.getElementById('taxRate').value);
            const { data, error } = await _supabase.from('propostas').select('*').order('created_at', { ascending: false });
            if (error) return;
            tableBody.innerHTML = '';
            let somaTotalGeral = 0;
            const hoje = new Date();

            data.forEach(item => {
                const dataC = new Date(item.created_at);
                const d1 = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                const d2 = new Date(dataC.getFullYear(), dataC.getMonth(), dataC.getDate());
                const diff = Math.floor((d1 - d2) / (1000 * 60 * 60 * 24));
                let juros = 0;
                let detalheJuro = "Taxa Fixa 20%";
                let badge = "";

                // L√≥gica de c√°lculo da tabela (mantida conforme original)
                if (diff <= 30) {
                    juros = item.valor * 0.20;
                    badge = diff === 0 ? `<span class="badge badge-today">Hoje</span>` : `<span class="badge badge-ok">${diff} dias</span>`;
                } else {
                    const extra = diff - 30;
                    juros = (item.valor * 0.20) + (item.valor * ((taxPos / 30) * extra));
                    badge = `<span class="badge badge-late">${diff} dias</span>`;
                    detalheJuro = `20% fixo + ${extra} dias extras`;
                }

                const total = item.valor + juros;
                somaTotalGeral += total;
                const totalFmt = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const whatsLimpo = item.whatsapp.replace(/\D/g,'');

                const msgRelatorio = encodeURIComponent(`üìä *RESUMO DO EMPR√âSTIMO*\n\nOl√° *${item.nome}*, segue os detalhes atualizados:\n\nüóì *DATA DE IN√çCIO:* ${dataC.toLocaleDateString('pt-BR')}\nüí∞ *VALOR ORIGINAL:* R$ ${item.valor.toLocaleString('pt-BR')}\n‚è≥ *TEMPO DECURSO:* ${diff} dias\nüìà *ENCARGOS:* ${detalheJuro}\n\nüíµ *TOTAL PARA QUITA√á√ÉO:* ${totalFmt}\n\n---------------------------------------\n‚ùì *COMO VOC√ä DESEJA RECEBER O VALOR?*\n( ) Via PIX\n( ) Em Dinheiro\n---------------------------------------`);
                const msgCobranca = encodeURIComponent(`‚ö†Ô∏è *AVISO DE COBRAN√áA*\n\nOl√° *${item.nome}*, o saldo hoje √© *${totalFmt}*.\n\nüìå *DADOS PIX (PicPay):*\n\nSuelho1911@gmail.com\n\n_Solicitamos a gentileza de encaminhar o comprovante ap√≥s a realiza√ß√£o do pagamento.ap√≥s o vencimento, o valor estar√° sujeito √† incid√™ncia de juros di√°rios!`);

                tableBody.innerHTML += `
                    <tr>
                        <td>${dataC.toLocaleDateString('pt-BR')}</td>
                        <td>${badge}</td>
                        <td><strong>${item.nome}</strong><br><small style="color:var(--text-muted); font-size: 0.7rem;">${item.bairro || ''}</small></td>
                        <td>R$ ${item.valor.toLocaleString('pt-BR')}</td>
                        <td style="color:var(--warning); font-weight:700">R$ ${juros.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td style="font-weight: 800;">${totalFmt}</td>
                        <td>
                            <div class="actions-div">
                                <a href="https://wa.me/55${whatsLimpo}?text=${msgRelatorio}" target="_blank" class="btn-action btn-relatorio">Relat√≥rio</a>
                                <a href="https://wa.me/55${whatsLimpo}?text=${msgCobranca}" target="_blank" class="btn-action btn-cobranca">Cobrar</a>
                                <button onclick="deletar('${item.id}')" class="btn-action btn-delete">X</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('total-receber').innerText = somaTotalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        async function deletar(id) {
            abrirModal('deleteModal');
            document.getElementById('confirmDeleteBtn').onclick = async () => {
                await _supabase.from('propostas').delete().eq('id', id);
                fecharModal('deleteModal'); carregarDados();
            };
        }
    </script>
</body>
</html>
